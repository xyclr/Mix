<?php
class http
{
    public $app;
    public $config;
    public $snoopy;
    public $logs;

    /**
     * Construct function, init app, config and snoopy.
     * 
     * @access public
     * @return void
     */
    public function __construct()
    {
        global $app, $config;
        $this->app    = $app;
        $this->config = $config;
        $this->snoopy = $this->app->loadClass('snoopy');
    }

    /**
     * Fetch a url by get.
     * 
     * @param  string    $url 
     * @access public
     * @return string
     */
    public function get($url)
    {
        $this->snoopy->fetch($url);
        $results = $this->snoopy->results;
        $this->log($url, $results);
        return $results;
    }

    /**
     * Post a request.
     * 
     * @param  string   $url 
     * @param  array    $vars 
     * @access public
     * @return string
     */
    public function post($url, $vars)
    {
        $this->snoopy->submit($url, $vars);
        $results = $this->snoopy->results;
        $this->log($url, $results);
        return $results;
    }

    /**
     * Log the url and results to a log file.
     * 
     * @param  string    $url 
     * @param  string    $results 
     * @access public
     * @return string
     */
    public function log($url, $results)
    {
        $logFile = $this->app->getLogRoot() . 'saas.'. date('Ymd') . '.log';
        $fh = @fopen($logFile, 'a');
        if(!$fh) return false;

        fwrite($fh, date('Ymd H:i:s') . ": " . $this->app->getURI() . "\n");
        fwrite($fh, "url:    " . $url . "\n");
        fwrite($fh, "results:" . print_r($results, true));
        fwrite($fh, "\n");
        fclose($fh);
    }
    /**
     * URL重定向
     * @param string $url 重定向的URL地址
     * @param integer $time 重定向的等待时间（秒）
     * @param string $msg 重定向前的提示信息
     * @return void
     */
    function redirect($url, $time = 0, $msg = '')
    {
    	//多行URL地址支持
    	$url = str_replace(array("\n", "\r"), '', $url);
    	if (empty($msg))
    		$msg = "系统将在{$time}秒之后自动跳转到{$url}！";
    	if (!headers_sent()) {
    		// redirect
    		if (0 === $time) {
    			header('Location: ' . $url);
    		} else {
    			header("refresh:{$time};url={$url}");
    			echo($msg);
    		}
    		exit();
    	} else {
    		$str = "<meta http-equiv='Refresh' content='{$time};URL={$url}'>";
    		if ($time != 0)
    			$str .= $msg;
    		exit($str);
    	}
    }
}
