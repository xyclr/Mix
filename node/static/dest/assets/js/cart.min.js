define(function (require, exports, module) {
    var dialog = require('jdf/1.0.0/ui/dialog/1.0.0/dialog');
    var switchable = require('jdf/1.0.0/ui/switchable/1.0.0/switchable');
    var area = require('jdf/1.0.0/ui/area/1.0.0/area');
    var tips = require('jdf/1.0.0/ui/tips/1.0.0/tips');
    var ceilinglamp = require('jdf/1.0.0/ui/ceilinglamp/1.0.0/ceilinglamp');

    var cartObj = {
        alamp:null,
        checkIsAll:false,
        init: function () {
            // 配送地址
            this.initArea();

            // 绑定事件
            this.bindCartEvent();

            // 初始化吸底
            this.ceilingAlamp();
        },

        initArea: function () {
            $('#jdarea').area({
                scopeLevel: 3,
                className: {
                    text: 'ui-area-text-wrap',
                    text_text: 'ui-area-text',
                    content: 'ui-area-content-wrap',
                    content_tab: 'ui-area-tab',
                    content_content: 'ui-area-content',
                    close: 'ui-area-close'
                }
            });
        },

        // 绑定事件：全部改为delegate
        bindCartEvent: function () {
            var me = this;

            // 增减商品数量
            this.bindskuNumEvent();

            // 删除商品 打开是否删除浮层
            $('.cart-warp').delegate('.cart-remove', 'click', function(){
                $('body').dialog({
                    title: '删除',
                    width: 400,
                    height: 50,
                    fixed: true,
                    hasCssLink: false,
                    hasButton: true,
                    submitButton: "移到我的收藏",
                    cancelButton: "删除",
                    type: 'html',
                    closeButton:true,
                    source: '<div class="ui-dialog-type ui-dialog-notice">'
                    + '<s></s>'
                    + '<div class="ui-dialog-info">'
                    + '<span class="dt">您确定要删除该商品？</span>'
                    + '<span class="dd">您可以选择移到我的收藏，或删除商品。</span>'
                    + '</div>'
                    + '</div>',
                    onSubmit: function () {
                        //alert('onSubmit');
                    },
                    onCancel: function () {
                        console.info($(this));
                    }
                });
            });

            //批量赠品
            $('.cart-warp .gift-item').delegate('.J-btn-del-gift', 'click', function(){
                $('body').dialog({
                    title: '删除',
                    width: 400,
                    height: 50,
                    fixed: true,
                    hasCssLink: false,
                    hasButton: true,
                    submitButton: "确定",
                    cancelButton: "取消",
                    type: 'html',
                    closeButton:true,
                    source: '<div class="ui-dialog-type ui-dialog-notice">'
                    + '<s></s>'
                    + '<div class="ui-dialog-info">'
                    + '<span class="dt">您确定要删除全部赠品吗？</span>'
                    + '<span class="dd">若点击确定，将删除该商品的全部赠品。如果您想添加赠品，需再重新将该商品添加到购物车中。</span>'
                    + '</div>'
                    + '</div>',
                    onSubmit: function () {
                        //alert('onSubmit');
                    },
                    onCancel: function () {
                        //alert('onCancel');
                    }
                });
            });

            //批量附件
            $('.cart-warp .gift-item').delegate('.J-btn-del-batch', 'click', function(){
                $('body').dialog({
                    title: '删除',
                    width: 400,
                    height: 50,
                    fixed: true,
                    hasCssLink: false,
                    hasButton: true,
                    submitButton: "确定",
                    cancelButton: "取消",
                    type: 'html',
                    closeButton:true,
                    source: '<div class="ui-dialog-type ui-dialog-notice">'
                    + '<s></s>'
                    + '<div class="ui-dialog-info">'
                    + '<span class="dt">您确定要删除全部附件吗？</span>'
                    + '<span class="dd">若点击确定，将删除该商品的全部附件。如果您想添加附件，需再重新将该商品添加到购物车中。</span>'
                    + '</div>'
                    + '</div>',
                    onSubmit: function () {
                        //alert('onSubmit');
                    },
                    onCancel: function () {
                        //alert('onCancel');
                    }
                });
            });
        },

        bindskuNumEvent:function(){
            var me = this;

            //全选
            $("#toggle-checkboxes_up,#toggle-checkboxes_down").click(function(){
                $("#toggle-checkboxes_up,#toggle-checkboxes_down").prop("checked",me.checkIsAll = !me.checkIsAll);
                me.toggleAll(me.checkIsAll)
            });

            //sku checkobx切换
            $('.cart-warp').delegate("input[name=checkItem]","click",function(){
                var that = $(this);
                var $parent = that.parents(".item-item");
                $parent.toggleClass("item-selected");
                if(me.checkIsAll && !$(this).prop("checked")) {
                    me.checkIsAll = false;
                    $("#toggle-checkboxes_up,#toggle-checkboxes_down").prop("checked",false);
                }

            });

            //移到我的关注
            $('.cart-warp').delegate(".cart-follow,.J-move-follow","click",function(){
                var that = $(this),
                    $parent = that.parents(".item-item"),
                    info = '',
                    $mask = '<div class="item-item-mask" style="z-index:6;position:absolute;left:0px;top:0px;width:100%;height:100%;background:rgba(255,255,255,0.9);"></div>'
                info = '<div class="op-tipmsg follow-tip" style="position:absolute;width:140px;display:none;color:#71B247;z-index:100;"><span class="s-icon succ-icon"></span>成功移到我的关注！</div>';
                if(that.hasClass('cart-follow')) {
                    $parent.append($mask);
                    me.showTipInfo($(that), info, false);
                    setTimeout(function(){
                        $parent.fadeOut().remove();
                    },1000)
                } else {
                    $(".item-item").each(function(){
                        $(this).append($mask);
                    });
                    me.showTipInfo($(that), info, false);
                }
                setTimeout(function(){
                    $('.item-item-mask') && $('.item-item-mask').fadeOut().remove();
                }, 2000);
            });

            //结算
             $(".J-submit-btn").click(function(){
                $(this).hide().parent().next().show();
             })
        },

        // 吸底
        ceilingAlamp: function(){
            var ceilinglamp = $('.cart-toolbar');
            var pos = 0;
            var defaultW = $("#cart-floatbar").width();
            $(window).bind("scroll resize", function() {
                pos = $(".footer-vsp").position().top - 100;
                fnCeilinglamp();
            }).trigger('scroll');

            function fnCeilinglamp(){
                if(((window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0) + $(window).height()) < pos) {
                    ceilinglamp.addClass("fixed-bottom");
                    ceilinglamp.width($('body').width());
                } else {
                    ceilinglamp.removeClass("fixed-bottom");
                    ceilinglamp.width(defaultW);
                }
            };
        },

        // 全选
        toggleAll: function(flag){
            $("input[name=checkItem]").each(function(){
                var that =$(this);
                var $parent = that.parents(".item-item");
                that.prop("checked",flag);
                flag ? $parent.addClass("item-selected") : $parent.removeClass("item-selected")
            });

        },

        //提示信息
        showTipInfo: function(objel, info, bright, bup){
            $('body').append(info);

            var tipEl = $('.op-tipmsg');

            if(objel){
                var left = objel.offset().left;
                left = bright ? (left + 20) : (left - 60);

                var top = objel.offset().top;
                top = (bup ? (top-35) : top);

                tipEl.css('top', top + 'px');
                tipEl.css('left', left + 'px');
            } else{
                var width = ($('.follow-batch').offset().left + $('.follow-batch').outerWidth() + 5) + 'px';
                tipEl.css('bottom', '10px');
                tipEl.css('left', width);
                tipEl.css('position', 'fixed');
                tipEl.css('z-index', '999');
            }

            tipEl.show();

            setTimeout(function(){
                tipEl && tipEl.fadeOut().remove();
            }, 2000);
        },

        closeTipInfo: function(){
            $('.op-tipmsg') &&  $('.op-tipmsg').fadeOut().remove();
        }
    }

    $(function(){
        cartObj.init();
        $(".J-order-tip").tips({
            trigger: '.tips'
        });
    })
});