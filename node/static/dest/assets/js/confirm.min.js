define(function (require, exports, module) {
    var dialog = require('jdf/1.0.0/ui/dialog/1.0.0/dialog');
    var scrollbar = require('jdf/1.0.0/ui/scrollbar/1.0.0/scrollbar');
    var drag = require('jdf/1.0.0/ui/drag/1.0.0/drag');
    var tips = require('jdf/1.0.0/ui/tips/1.0.0/tips');
    var ceilinglamp = require('jdf/1.0.0/ui/ceilinglamp/1.0.0/ceilinglamp');

    var consigneeObj = {
        consigneeScroll: null,
        init: function(){

            //绑定事件
            this.bindConsigneeEvent();

            // 初始化吸底
            $("#checkout-floatbar").length && this.ceilingAlamp();

        },

        bindConsigneeEvent: function(){
            var that = this;
            var $consigneeList = $("#consignee-list");


            //新增收货地址
            $(".checkout-steps").delegate('.J-add-addr','click',function(){
                var addAddrDialog = $('body').dialog({
                    title: '新增收货人信息',
                    width: 700,
                    height: 260,
                    fixed: true,
                    hasCssLink: false,
                    hasButton: true,
                    submitButton: "保存收货人信息",
                    cancelButton: "取消",
                    type: 'html',
                    closeButton:true,
                    source:
                    '<div class="form consignee-form" id="consignee-form" name="consignee-form">'
                    +   '<div class="item" id="name_div">'
                    +       '<span class="label"><span style="color:red">*</span>&nbsp;收货人：</span>'
                    +       '<div class="f-fl">'
                    +       ' <input type="text" class="itxt" id="consignee_name" name="consigneeParam.name" maxlength="20" value="" tabindex="1">'
                    +       ' <span class="error-msg f-db" id="name_div_error">地址错误!</span>'
                    +       '</div>'
                    +   '</div>'
                    +   '<div class="item" id="area_div">'
                    +       '<span class="label"><span style="color:red">*</span>&nbsp;所在地区：</span>'
                    +       '<div class="f-fl"><span id="span_area"> <span defaultadd="" id="span_province"> <select name="receiveProvinceId" id="receiveProvinceId"> <option value="-1">请选择</option> </select> </span> <span defaultadd="" id="span_county"> <select id="receiveCountryId" name="receiveCountryId"><option value="-1">请选择</option> </select> </span> <span defaultadd="" id="span_town"> <select id="receiveTownId" name="receiveTownId" class="sel"><option value="-1">请选择请选择请选择请选择请选择请选择请选择请选择请选择请选择请选择请选择请选择</option></select> </span> </span></div>'
                    +   '</div>'
                    +   '<div class="item">'
                    +       '<span class="label" id="address_div"><span style="color:red">*</span>&nbsp;详细地址：</span>'
                    +       '<div class="f-fl">'
                    +           '<input type="text" class="itxt itxt02" id="consignee_address" name="consigneeParam.address" maxlength="50"  value="" tabindex="6">'
                    +           '<span class="error-msg" id="address_div_error"></span>'
                    +       '</div>'
                    +   '</div>'
                    +   '<div class="item" id="call_div">'
                    +       '<span class="label"><span style="color:red">*</span>&nbsp;手机号码：</span>'
                    +       '<div class="f-fl">'
                    +           '<input type="text" class="itxt " id="consignee_mobile" name="consigneeParam.mobile" onfocus="if(value == defaultValue){value=' + "''" +';}"  maxlength="11" value="" tabindex="7">'
                    +       '</div>'
                    +       '<div class="f-fl">'
                    +           '<span class="label">固定电话：</span>'
                    +           '<input type="text" class="itxt" id="consignee_phone" name="consigneeParam.phone" onfocus="if(value == defaultValue){value=' + "''" +';}"  maxlength="20" value="" tabindex="8">'
                    +       '</div>'
                    +       '<span class="error-msg" id="call_div_error"></span>'
                    +   '</div>'
                    +   '<div class="item" id="email_div">'
                    +       '<span class="label">邮箱：</span>'
                    +       '<div class="f-fl">'
                    +           '<input type="text" class="itxt" name="consigneeParam.email" maxlength="50"  value="" onfocus="if(value == defaultValue){value=' + "''" +';}" tabindex="9">'
                    +           '<span class="error-msg" id="email_div_error"></span>'
                    +           '<div>用来接收订单提醒邮件，便于您及时了解订单状态</div>'
                    +       '</div>'
                    +   '</div>'
                    +   '<div class="item">'
                    +       '<span class="label">&nbsp;</span>'
                    +       '<div class="f-fl">'
                    +           '<a href="#none" class="btn-9"><span>保存收货人信息</span></a>'
                    +           '<div style="display:none"><b></b>正在提交信息，请等待！</div>'
                    +       '</div>'
                    +    '</div>'
                    +'</div>',
                    onSubmit: function () {
                        if($consigneeList.find("li .item-selected span").length) {
                            $consigneeList.find("li .item-selected span")
                                .html($consigneeList.find("li .item-selected span").attr('title'))
                                .parent().removeClass('item-selected').parent().removeClass("ui-switchable-panel-selected");
                        }
                        $consigneeList.prepend('<li class="ui-switchable-panel ui-switchable-panel-selected"> <div class="consignee-item item-selected" > <span title="王麻子new 新疆">默认地址</span><b></b> </div> <div class="addr-detail"> <span class="addr-name" title="王麻子">王麻子new</span> <span class="addr-info" title="新疆维吾尔自治区伊犁哈萨克自治州塔城地区额敏县杰勒阿尕什镇哼哼哈哈小区8号楼3单元19号">新疆维吾尔自治区伊犁哈萨克自治州塔城地区额敏县杰勒阿尕什镇哼哼哈哈小区8号楼3单元19号</span> <span class="addr-tel">186****2771</span> </div> <div class="op-btns"><span></span> <a href="#none" class="edit-consignee">编辑</a> <a href="#none" class="del-consignee">删除</a> </div> </li>');
                        addAddrDialog.close();
                        if($("#consignee-list li").length > 3 && ($("#consigneeItemAllClick").css("display") == "block")) {
                            $("#consigneeItemAllClick").click();
                        }
                        that.loadScrollbar();
                    },
                    onCancel: function () {

                    }
                });
            });

            //删除收货地址
            $(".checkout-steps").delegate('.del-consignee','click',function(){
                var $parent = $(this).parents(".ui-switchable-panel");
                if($parent.hasClass("ui-switchable-panel-selected")) {
                    $consigneeList.eq(0)
                        .addClass("ui-switchable-panel-selected")
                        .find(".consignee-item")
                        .addClass(".item-selected");
                }
                $parent.remove();
                if(that.consigneeScroll) {
                    //滚轮从新定位
                    that.consigneeScroll.goTop();
                }
                that.loadScrollbar();
            });

            //展开收货地址
            $("#consigneeItemAllClick").click(function(){
                $("#consigneeItemAllClick").addClass("f-dn");
                $("#consigneeItemHideClick").removeClass("f-dn");
                $("#del_consignee_type").val("0");
                $("#consignee1").removeClass("consignee-off");
                $(".consignee-item").parents("li").css("display","list-item");
                var _height = ($("#consignee-list li").length * 42)+"px";
                $('.consignee-cont').css({'height': _height});
                $('.ui-scrollbar-wrap').css({'height':_height});
                that.loadScrollbar();
            });
            //收起收货地址
            $("#consigneeItemHideClick").click(function(){
                $("#consigneeItemAllClick").removeClass("f-dn");
                $("#consigneeItemHideClick").addClass("f-dn");
                $("#consignee1").addClass("consignee-off");
                $("#del_consignee_type").val("1");
                $('.consignee-cont').css({'height':'42px'});
                $('.ui-scrollbar-bg').css('display', 'none');
                $('.consignee-scrollbar').css({'height': '', 'position': ''});
                $('.ui-scrollbar-item').css('display', 'none');
                $('.ui-scrollbar-wrap').css('height', '42px');
                $('#consignee-content ul').css({
                    'top': '0px',
                    'position':'absolute'
                });
                if(that.consigneeScroll) {
                    //滚轮从新定位
                    that.consigneeScroll.goTop();
                }
            });

            //地址切换和hover效果
            $("#consignee-list").delegate('.consignee-item','click',function(){
                var txt = $("#consignee-list .item-selected span").attr("title");
                $("#consignee-list .consignee-item.item-selected")
                    .removeClass("item-selected").find("span").html(txt);
                $(this).addClass("item-selected")
            });
            $("#consignee-list").delegate('li','mouseenter',function(){
                $(this).addClass("li-hover");
            });
            $("#consignee-list").delegate('li','mouseleave',function(){
                $(this).removeClass("li-hover");
            });

            //设为默认地址
            $(".checkout-steps").delegate('.setdefault-consignee','click',function(){
                $("#consignee-list .consignee-item.item-selected").removeClass("item-selected");
                $("#consignee-list li.ui-switchable-panel-selected").removeClass("ui-switchable-panel-selected");
                $(this).parents("li").addClass("ui-switchable-panel-selected").find(".consignee-item").addClass("item-selected");
            });

            //票据修改
            $(".checkout-steps").delegate('.J-invoice-modify','click',function(){
                var invoiceDialog = $('body').dialog({
                    title: '发票信息',
                    width: 700,
                    height: 360,
                    fixed: true,
                    hasCssLink: false,
                    hasButton: false,
                    submitButton: "保存发票信息",
                    cancelButton: "取消",
                    type: 'iframe',
                    closeButton:true,
                    source:'invoice.html',
                    onSubmit: function () {
                        invoiceDialog.close();
                    },
                    onCancel: function () {

                    }
                });
                return false;
            });


        },

        loadScrollbar: function() {
            var that = this;
            if ($("#consignee-list li").length > 4) {
                if (that.consigneeScroll) {
                    that.consigneeScroll.resetUpdate($("#consignee-list li").length);
                } else {
                    that.consigneeScroll = $('.consignee-scrollbar').scrollbar({
                        width: 11,
                        scrollClass: 'ui-scrollbar-item',
                        mainClass: 'ui-scrollbar-main',
                        hasHeadTail: false,
                        limit: true,
                        wrapHeight: 168
                    });
                    that.consigneeScroll.resetUpdate = function (length) {
                        //$("#del_consignee_type").val() 展开修改成0  收起修改成1  新增修改成0
                        var flag = $("#del_consignee_type").val();
                        if (flag == "0") {
                            var _height = (length * 42);
                            $('.consignee-cont').css({'height': _height + "px"});
                            if (_height >= 168) {
                                $('.ui-scrollbar-wrap').css({'height': '168px'});
                            } else {
                                $('.ui-scrollbar-wrap').css({'height': _height + "px"});
                            }
                        }
                        console.info(length);
                        console.info(flag);
                        if (length > 4 && flag == "0") {// 展开状态才显示，否则保持不变
                            $('.ui-scrollbar-bg').css({'display': 'block', 'top': '0'});
                            $('.consignee-scrollbar').css('position', 'absolute');
                        } else {
                            $('.ui-scrollbar-bg').css('display', 'none');
                            $('.consignee-scrollbar').css({'height': '', 'position': ''});
                        }
                        this.update();
                    };
                }
            }
            else {
                var _height = ($("#consignee-list li").length * 42)+"px";
                $('.consignee-cont').css({'height': _height});
                $('.ui-scrollbar-wrap').css({'height':_height});
                that.consigneeScroll.resetUpdate($("#consignee-list li").length);
                            }
        },

        // 吸底
        ceilingAlamp: function(){
            //$(window).bind("scroll resize", function() {
            //    pos = $(".footer-vsp").position().top - 100;
            //    fnCeilinglamp();
            //}).trigger('scroll');
            //
            //function fnCeilinglamp(){
            //    if(((window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0) + $(window).height()) < pos) {
            //        ceilinglamp.addClass("ui-ceilinglamp-current");
            //        ceilinglamp.width($('body').width());
            //    } else {
            //        ceilinglamp.removeClass("ui-ceilinglamp-current");
            //        ceilinglamp.width(defaultW);
            //    }
            //};

            var b;
            {
                var c = $(window).height(), e = ($(window).width(), $(".ui-ceilinglamp").outerHeight()), f = $("#checkout-floatbar").offset().top + e;
                6 == $.browser.version
            }
            $(window).scroll(function () {
                f = $("#checkout-floatbar").offset().top + e;
                var a = $(document).scrollTop();
                f > c + a ? $(".ui-ceilinglamp").addClass("ui-ceilinglamp-current") : $(".ui-ceilinglamp").removeClass("ui-ceilinglamp-current").removeAttr("style")
            }).resize(function () {
                clearTimeout(b), b = setTimeout(function () {
                    c = $(window).height()
                }, 500)
            })
        },
    }

    $(function(){
        consigneeObj.init();
        $(".J-stock-tip").tips({
            trigger: '.tips'
        });

        $(".J-yf-tip").tips({
            trigger: '.tips'
        });

    });

});